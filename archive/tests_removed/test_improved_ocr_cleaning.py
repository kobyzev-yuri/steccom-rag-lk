#!/usr/bin/env python3
"""
–¢–µ—Å—Ç —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ OCR —Ç–µ–∫—Å—Ç–∞
"""

import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), 'kb_admin'))

from kb_admin.modules.core.smart_document_agent import SmartLibrarian
from kb_admin.modules.knowledge_base.kb_manager import KnowledgeBaseManager

def test_improved_ocr_cleaning():
    """–¢–µ—Å—Ç —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ OCR"""
    
    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ OCR —Ç–µ–∫—Å—Ç–∞")
    print("=" * 60)
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º SmartLibrarian
    kb_manager = KnowledgeBaseManager()
    smart_librarian = SmartLibrarian(kb_manager)
    
    # –¢–µ—Å—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Å –∫—Ä–∞–∫–æ–∑—è–±—Ä–∞–º–∏ (—Ç–æ—Ç –∂–µ, —á—Ç–æ –ø–æ–∫–∞–∑–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
    test_ocr_text = """–°–ò–°–¢–ï–ú–ê –°–ï–†–¢–ò–§–ò–ö–ê–¶–ò–ò –û–ë–õ–ê–°–¢–ò –°–í–Ø–ó–ò –°–ï–†–¢–ò–§–ò–ö–ê–¢ –°–û–û–¢–í–ï–¢–°–¢–í–ò–Ø –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä: –û–°-3-–°–¢-0274 –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: —Å 27 —è–Ω–≤–∞—Ä—è 2010–≥. –¥–æ 27 —è–Ω–≤–∞—Ä—è 2011–≥. –ê Scorer –ù–ê–°–¢–û–Ø–©–ò–ú –°–ï–†–¢–ò–§–ò–ö–ê–¢–û–ú –û–†–ì–ê–ù –°–ï–†–¢–ò–§–ò–ö–ê–¶–ò–ò Te tT AHO ¬´II KC¬ª, 111024, –≥. –ú–æ—Å–∫–≤–∞, —É–ª. –ê–≤–∏–∞–º–æ—Ç–æ—Ä–Ω–∞—è, –¥. 8A {—Å–æ–∫—Ä–∞—à–µ–Ω–Ω–æ–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∞ –ø–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏, –∞–ª—Ä–µ—Å –º–µ—Å—Ç–∞ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –£–î–û–°–¢–û–í–ï–†–Ø–ï–¢, –ß–¢–û ‚Äî —Å–∏—Å—Ç–µ–º–∞ —Ä–∞—Å—á–µ—Ç–æ–≤ ¬´–ë–∏–ª–ª-–ú–∞—Å—Ç–µ—Ä¬ª –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ epee na —Å–≤—è–∑–∏. pepe –∏—è (–®—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É—Å–ª–æ–≤–∏—è 2 –∏) (–í–µ—Ä—Å–∏—è –ü–û 7) –≤ —Å–æ—Å—Ç–∞–≤–µ —Å–æ–≥–ª–∞—Å–Ω–æ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—é, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É—Å–ª–æ–≤–∏—è ‚Ññ TY 4251-010-47397453- 2009. –Ω–µ—Ö —É –∂–µ =: : SSS Sa –ü–†–û–ò–ó–í–û–î–ò–ú–´–ï –û–û–û ¬´–ò–Ω–ª–∞–π–Ω –¢–µ–ª–µ–∫–æ–º –°–æ–ª—é—à–∏—Å¬ª, 127521, –≥. –ú–æ—Å–∫–≤–∞, > (–í–∞—é–º–µ–Ω–æ–≤—è–Ω–∏–µ –∏–æ–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—è —Å—Ä–µ–¥—Å—Ç–≤–∞ —Å–≤—è–∑–∏ –∞–ª—Ä–µ—Å –º–µ—Å—Ç–∞ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è) —É–ª. –û–∫—Ç—è–±—Ä—å—Å–∫–∞—è, –¥. 72 –ü–†–ï–î–ü–†–ò–Ø–¢–ò–ò (–ó–ê–í–û–î–ï) OOO ¬´–ò–Ω–ª–∞–π–Ω –¢–µ–ª–µ–∫–æ–º –°–æ–ª—é—à–∏—Å¬ª, 127521, –≥. –ú–æ—Å–∫–≤–∞, (–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è ( —Å—Ä–µ–¥—Å—Ç–≤–∞ —Å–≤—è—Ç–∏. –∞–¥—Ä–µ—Å –º–µ—Å—Ç–∞ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è) –°–û–û–¢–í–ï–¢–°–¢–í–£–Æ–¢ –£–°–¢–ê–ù–û–í–õ–ï–ù–ù–´–ú –¢–†–ï–ë–û–í–ê–ù–ò–Ø–ú ¬´–ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º —Ä–∞—Å—á–µ—Ç–æ–≤¬ª (—É—Ç–≤. –ü—Ä–∏–∫–∞–∑–æ–º –ú–∏–Ω–∏–Ω—Ñ–æ—Ä–º—Å–≤—è–∑–∏ –†–æ—Å—Å–∏–∏ –æ—Ç 02.07.2007 –≥. ‚Ññ7..."""
    
    print(f"–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç ({len(test_ocr_text)} —Å–∏–º–≤–æ–ª–æ–≤):")
    print("-" * 40)
    print(test_ocr_text[:200] + "..." if len(test_ocr_text) > 200 else test_ocr_text)
    print("-" * 40)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫—Ä–∞–∫–æ–∑—è–±—Ä
    krakozyabry = [
        "epee na —Å–≤—è–∑–∏. pepe –∏—è",
        "–û –±—Ä –û–û–ù es 5 –ï–ï –ï–ï–ï–í–ï–ï–ï–†–´–ï–ï–†–ï–ï–ï", 
        "ee ae oe ae oe eo se ee Se SSS Sa",
        "–í–∞—é–º–µ–Ω–æ–≤—è–Ω–∏–µ –∏–æ–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—è",
        "–∑–∞–≤–æ–ª–∞] - –∏–∑–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—è",
        "–µ–µ–µ –°–û–û–¢–í–ï–¢–°–¢–í–£–Æ–¢",
        "–Ω–µ—Ö —É –∂–µ =: :",
        "SSS Sa"
    ]
    
    print("\nüîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫—Ä–∞–∫–æ–∑—è–±—Ä –≤ –∏—Å—Ö–æ–¥–Ω–æ–º —Ç–µ–∫—Å—Ç–µ:")
    found_krakozyabry = []
    for krakozyabry_text in krakozyabry:
        if krakozyabry_text in test_ocr_text:
            found_krakozyabry.append(krakozyabry_text)
            print(f"  ‚ùå –ù–∞–π–¥–µ–Ω–æ: '{krakozyabry_text}'")
        else:
            print(f"  ‚úÖ –ù–µ –Ω–∞–π–¥–µ–Ω–æ: '{krakozyabry_text}'")
    
    print(f"\nüìä –ù–∞–π–¥–µ–Ω–æ –∫—Ä–∞–∫–æ–∑—è–±—Ä: {len(found_krakozyabry)} –∏–∑ {len(krakozyabry)}")
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ—á–∏—Å—Ç–∫—É
    print("\nüßπ –ó–∞–ø—É—Å–∫–∞–µ–º —É–ª—É—á—à–µ–Ω–Ω—É—é –æ—á–∏—Å—Ç–∫—É OCR...")
    try:
        cleaned_text = smart_librarian._clean_ocr_text(test_ocr_text)
        
        print(f"\nüìÑ –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—á–∏—Å—Ç–∫–∏ ({len(cleaned_text)} —Å–∏–º–≤–æ–ª–æ–≤):")
        print("=" * 50)
        print(cleaned_text)
        print("=" * 50)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É–¥–∞–ª–∏–ª–∏—Å—å –ª–∏ –∫—Ä–∞–∫–æ–∑—è–±—Ä—ã
        print("\nüîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—á–∏—Å—Ç–∫–∏:")
        removed_krakozyabry = []
        remaining_krakozyabry = []
        
        for krakozyabry_text in found_krakozyabry:
            if krakozyabry_text in cleaned_text:
                remaining_krakozyabry.append(krakozyabry_text)
                print(f"  ‚ùå –û—Å—Ç–∞–ª–æ—Å—å: '{krakozyabry_text}'")
            else:
                removed_krakozyabry.append(krakozyabry_text)
                print(f"  ‚úÖ –£–¥–∞–ª–µ–Ω–æ: '{krakozyabry_text}'")
        
        print(f"\nüìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—á–∏—Å—Ç–∫–∏:")
        print(f"  –£–¥–∞–ª–µ–Ω–æ –∫—Ä–∞–∫–æ–∑—è–±—Ä: {len(removed_krakozyabry)}")
        print(f"  –û—Å—Ç–∞–ª–æ—Å—å –∫—Ä–∞–∫–æ–∑—è–±—Ä: {len(remaining_krakozyabry)}")
        print(f"  –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {len(removed_krakozyabry)/len(found_krakozyabry)*100:.1f}%")
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        print(f"\nüìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
        print(f"  –ò—Å—Ö–æ–¥–Ω–∞—è –¥–ª–∏–Ω–∞: {len(test_ocr_text)}")
        print(f"  –û—á–∏—â–µ–Ω–Ω–∞—è –¥–ª–∏–Ω–∞: {len(cleaned_text)}")
        print(f"  –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ: {len(test_ocr_text) - len(cleaned_text)} —Å–∏–º–≤–æ–ª–æ–≤")
        print(f"  –ü—Ä–æ—Ü–µ–Ω—Ç —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è: {(len(test_ocr_text) - len(cleaned_text))/len(test_ocr_text)*100:.1f}%")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—á–µ—Å—Ç–≤–æ –æ—á–∏—â–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        print(f"\nüìã –ê–Ω–∞–ª–∏–∑ –∫–∞—á–µ—Å—Ç–≤–∞:")
        if "–°–ï–†–¢–ò–§–ò–ö–ê–¢ –°–û–û–¢–í–ï–¢–°–¢–í–ò–Ø" in cleaned_text:
            print("  ‚úÖ –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞")
        else:
            print("  ‚ùå –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ—Ç–µ—Ä—è–Ω–∞")
            
        if "–û–°-3-–°–¢-0274" in cleaned_text:
            print("  ‚úÖ –ù–æ–º–µ—Ä —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω")
        else:
            print("  ‚ùå –ù–æ–º–µ—Ä —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –ø–æ—Ç–µ—Ä—è–Ω")
            
        if "–ë–∏–ª–ª-–ú–∞—Å—Ç–µ—Ä" in cleaned_text:
            print("  ‚úÖ –ù–∞–∑–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ")
        else:
            print("  ‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –ø–æ—Ç–µ—Ä—è–Ω–æ")
        
        return len(remaining_krakozyabry) == 0
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ: {e}")
        return False

if __name__ == "__main__":
    success = test_improved_ocr_cleaning()
    
    print(f"\n{'='*60}")
    if success:
        print("üéâ –¢–ï–°–¢ –ü–†–û–ô–î–ï–ù: –í—Å–µ –∫—Ä–∞–∫–æ–∑—è–±—Ä—ã —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã!")
    else:
        print("‚ö†Ô∏è –¢–ï–°–¢ –ß–ê–°–¢–ò–ß–ù–û –ü–†–û–ô–î–ï–ù: –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∫—Ä–∞–∫–æ–∑—è–±—Ä—ã –æ—Å—Ç–∞–ª–∏—Å—å")
    print(f"{'='*60}")

